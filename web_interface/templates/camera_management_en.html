<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Management - Self Brain AGI</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/fontawesome.min.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        /* Simple black and white style */
        body {
            background-color: #f8f9fa;
            color: #333;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #e9ecef;
            border-bottom: 1px solid #ddd;
        }
        .btn {
            border-radius: 3px;
            font-weight: 500;
        }
        .btn-primary {
            background-color: #333;
            border-color: #333;
        }
        .btn-primary:hover {
            background-color: #555;
            border-color: #555;
        }
        .btn-secondary {
            background-color: #666;
            border-color: #666;
        }
        .btn-secondary:hover {
            background-color: #888;
            border-color: #888;
        }
        .btn-danger {
            background-color: #999;
            border-color: #999;
        }
        .btn-danger:hover {
            background-color: #777;
            border-color: #777;
        }
        .form-control {
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .camera-preview {
            border: 1px solid #ddd;
            background-color: #f8f9fa;
            position: relative;
            min-height: 240px;
        }
        .status-active {
            background-color: #4CAF50;
        }
        .status-inactive {
            background-color: #ccc;
        }
        .status-error {
            background-color: #f44336;
        }
        .camera-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .camera-control-panel {
            background-color: #f8f9fa;
            border-top: 1px solid #ddd;
            padding: 10px;
        }
        .camera-info {
            font-size: 12px;
            color: #666;
        }
        #depthMapCanvas {
            width: 100%;
            height: 100%;
            background-color: #000;
        }
        .snapshot-item {
            border: 1px solid #ddd;
            padding: 5px;
            margin-bottom: 10px;
            border-radius: 3px;
            background-color: #fff;
        }
        .snapshot-img {
            max-width: 100%;
            height: auto;
            border-radius: 3px;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            background-color: #333;
            color: white;
            border-radius: 3px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2 class="mb-4">Camera Management</h2>
        
        <!-- Camera Control Panel -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Camera Controls</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Camera Selection -->
                    <div class="col-md-4 mb-3">
                        <div class="mb-2">
                            <label for="camera1Selector" class="form-label">Left Camera</label>
                            <select id="camera1Selector" class="form-control">
                                <option value="default">Select Camera</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label for="camera2Selector" class="form-label">Right Camera</label>
                            <select id="camera2Selector" class="form-control">
                                <option value="default">Select Camera</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label for="camera3Selector" class="form-label">Top Camera (Optional)</label>
                            <select id="camera3Selector" class="form-control">
                                <option value="default">Select Camera</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label for="cameraResolution" class="form-label">Resolution</label>
                            <select id="cameraResolution" class="form-control">
                                <option value="640x480">640x480</option>
                                <option value="1280x720" selected>1280x720</option>
                                <option value="1920x1080">1920x1080</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Control Buttons -->
                    <div class="col-md-4 mb-3">
                        <button id="refreshCameras" class="btn btn-secondary w-100 mb-2">Refresh Cameras</button>
                        <button id="startStereoVisionBtn" class="btn btn-primary w-100 mb-2">Start Stereo Vision</button>
                        <button id="takeSnapshotsBtn" class="btn btn-secondary w-100 mb-2">Take Snapshots</button>
                        <button id="stopAllCamerasBtn" class="btn btn-danger w-100 mb-2">Stop All Cameras</button>
                        <button id="toggleDepthMapBtn" class="btn btn-secondary w-100">Toggle Depth Map</button>
                    </div>
                    
                    <!-- Camera Status -->
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h4>Camera Status</h4>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <span id="camera1Status" class="camera-status-indicator status-inactive"></span>
                                    <span>Left Camera: <span id="camera1StatusText">Inactive</span></span>
                                </div>
                                <div class="mb-2">
                                    <span id="camera2Status" class="camera-status-indicator status-inactive"></span>
                                    <span>Right Camera: <span id="camera2StatusText">Inactive</span></span>
                                </div>
                                <div class="mb-2">
                                    <span id="camera3Status" class="camera-status-indicator status-inactive"></span>
                                    <span>Top Camera: <span id="camera3StatusText">Inactive</span></span>
                                </div>
                                <div class="mb-2">
                                    <span id="depthMapStatus" class="camera-status-indicator status-inactive"></span>
                                    <span>Depth Map: <span id="depthMapStatusText">Inactive</span></span>
                                </div>
                                <div class="mt-3 camera-info">
                                    <div><strong>Connection Status:</strong> <span id="cameraConnectionStatus">Not connected</span></div>
                                    <div><strong>Resolution:</strong> <span id="cameraResolution">--x--</span></div>
                                    <div><strong>FPS:</strong> <span id="cameraFps">--</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Camera Preview Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Camera Preview</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Left Camera Preview -->
                    <div class="col-md-4 mb-3">
                        <div id="camera1Preview" class="camera-preview relative">
                            <span id="camera1Status" class="absolute top-1 right-1 text-white text-xs px-1 rounded bg-gray-700">Inactive</span>
                            <video id="camera1Video" class="w-full h-full object-cover" autoplay muted></video>
                        </div>
                        <div class="camera-control-panel mt-2">
                            <div class="btn-group w-100" role="group">
                                <button id="startCamera1Btn" class="btn btn-secondary">Start</button>
                                <button id="stopCamera1Btn" class="btn btn-danger">Stop</button>
                                <button id="snapshotCamera1Btn" class="btn btn-secondary">Snapshot</button>
                                <button id="settingsCamera1Btn" class="btn btn-secondary">Settings</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Camera Preview -->
                    <div class="col-md-4 mb-3">
                        <div id="camera2Preview" class="camera-preview relative">
                            <span id="camera2Status" class="absolute top-1 right-1 text-white text-xs px-1 rounded bg-gray-700">Inactive</span>
                            <video id="camera2Video" class="w-full h-full object-cover" autoplay muted></video>
                        </div>
                        <div class="camera-control-panel mt-2">
                            <div class="btn-group w-100" role="group">
                                <button id="startCamera2Btn" class="btn btn-secondary">Start</button>
                                <button id="stopCamera2Btn" class="btn btn-danger">Stop</button>
                                <button id="snapshotCamera2Btn" class="btn btn-secondary">Snapshot</button>
                                <button id="settingsCamera2Btn" class="btn btn-secondary">Settings</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Camera Preview -->
                    <div class="col-md-4 mb-3">
                        <div id="camera3Preview" class="camera-preview relative">
                            <span id="camera3Status" class="absolute top-1 right-1 text-white text-xs px-1 rounded bg-gray-700">Inactive</span>
                            <video id="camera3Video" class="w-full h-full object-cover" autoplay muted></video>
                        </div>
                        <div class="camera-control-panel mt-2">
                            <div class="btn-group w-100" role="group">
                                <button id="startCamera3Btn" class="btn btn-secondary">Start</button>
                                <button id="stopCamera3Btn" class="btn btn-danger">Stop</button>
                                <button id="snapshotCamera3Btn" class="btn btn-secondary">Snapshot</button>
                                <button id="settingsCamera3Btn" class="btn btn-secondary">Settings</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Depth Map Section -->
                <div id="depthMapContainer" class="hidden mt-4">
                    <div class="card">
                        <div class="card-header">
                            <h4>Depth Map Visualization</h4>
                        </div>
                        <div class="card-body">
                            <canvas id="depthMapCanvas" width="1280" height="720"></canvas>
                            <div class="text-center text-sm text-gray-600 mt-2">Simulated Depth Map (Red = Near, Blue = Far)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Camera Snapshots Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Camera Snapshots</h3>
            </div>
            <div class="card-body">
                <div id="snapshotsContainer" class="row">
                    <!-- Snapshots will be displayed here -->
                    <div class="col-12 text-center text-gray-500 py-4">
                        No snapshots taken yet
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Settings Modal -->
    <div class="modal fade" id="cameraSettingsModal" tabindex="-1" aria-labelledby="cameraSettingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cameraSettingsModalLabel">Camera Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="cameraSettingsForm">
                        <!-- Form fields will be populated dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="saveCameraSettingsBtn" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/camera_control.js"></script>
    <script src="/static/js/camera_manager.js"></script>
    <script>
        // Initialize camera control and manager
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize camera control
            const cameraControl = window.cameraControl || new CameraControl();
            
            // Initialize camera manager
            const cameraManager = new CameraManager();
            
            // List available cameras
            listAllCameras();
            
            // Event listeners for individual camera controls
            document.getElementById('startCamera1Btn').addEventListener('click', function() {
                const cameraId = document.getElementById('camera1Selector').value;
                if (cameraId && cameraId !== 'default') {
                    cameraControl.startCamera(cameraId);
                } else {
                    showNotification('Please select a camera', 'error');
                }
            });
            
            document.getElementById('stopCamera1Btn').addEventListener('click', function() {
                const cameraId = document.getElementById('camera1Selector').value;
                if (cameraId && cameraId !== 'default') {
                    cameraControl.stopCamera(cameraId);
                }
            });
            
            document.getElementById('snapshotCamera1Btn').addEventListener('click', function() {
                const cameraId = document.getElementById('camera1Selector').value;
                if (cameraId && cameraId !== 'default') {
                    cameraControl.takeSnapshot(cameraId);
                    showNotification('Snapshot taken', 'success');
                }
            });
            
            document.getElementById('settingsCamera1Btn').addEventListener('click', function() {
                const cameraId = document.getElementById('camera1Selector').value;
                if (cameraId && cameraId !== 'default') {
                    openCameraSettingsModal(cameraId, 'Left Camera');
                }
            });
            
            // Similar event listeners for camera 2 and 3
            document.getElementById('startCamera2Btn').addEventListener('click', function() {
                const cameraId = document.getElementById('camera2Selector').value;
                if (cameraId && cameraId !== 'default') {
                    cameraControl.startCamera(cameraId);
                } else {
                    showNotification('Please select a camera', 'error');
                }
            });
            
            document.getElementById('stopCamera2Btn').addEventListener('click', function() {
                const cameraId = document.getElementById('camera2Selector').value;
                if (cameraId && cameraId !== 'default') {
                    cameraControl.stopCamera(cameraId);
                }
            });
            
            document.getElementById('snapshotCamera2Btn').addEventListener('click', function() {
                const cameraId = document.getElementById('camera2Selector').value;
                if (cameraId && cameraId !== 'default') {
                    cameraControl.takeSnapshot(cameraId);
                    showNotification('Snapshot taken', 'success');
                }
            });
            
            document.getElementById('settingsCamera2Btn').addEventListener('click', function() {
                const cameraId = document.getElementById('camera2Selector').value;
                if (cameraId && cameraId !== 'default') {
                    openCameraSettingsModal(cameraId, 'Right Camera');
                }
            });
            
            document.getElementById('startCamera3Btn').addEventListener('click', function() {
                const cameraId = document.getElementById('camera3Selector').value;
                if (cameraId && cameraId !== 'default') {
                    cameraControl.startCamera(cameraId);
                } else {
                    showNotification('Please select a camera', 'error');
                }
            });
            
            document.getElementById('stopCamera3Btn').addEventListener('click', function() {
                const cameraId = document.getElementById('camera3Selector').value;
                if (cameraId && cameraId !== 'default') {
                    cameraControl.stopCamera(cameraId);
                }
            });
            
            document.getElementById('snapshotCamera3Btn').addEventListener('click', function() {
                const cameraId = document.getElementById('camera3Selector').value;
                if (cameraId && cameraId !== 'default') {
                    cameraControl.takeSnapshot(cameraId);
                    showNotification('Snapshot taken', 'success');
                }
            });
            
            document.getElementById('settingsCamera3Btn').addEventListener('click', function() {
                const cameraId = document.getElementById('camera3Selector').value;
                if (cameraId && cameraId !== 'default') {
                    openCameraSettingsModal(cameraId, 'Top Camera');
                }
            });
            
            // Toggle depth map
            document.getElementById('toggleDepthMapBtn').addEventListener('click', function() {
                toggleDepthMap();
            });
            
            // Save camera settings
            document.getElementById('saveCameraSettingsBtn').addEventListener('click', function() {
                saveCameraSettings();
            });
        });
        
        // Function to open camera settings modal
        function openCameraSettingsModal(cameraId, cameraName) {
            const modal = new bootstrap.Modal(document.getElementById('cameraSettingsModal'));
            const modalTitle = document.getElementById('cameraSettingsModalLabel');
            const formContainer = document.getElementById('cameraSettingsForm');
            
            modalTitle.textContent = `${cameraName} Settings`;
            
            // Store camera ID in form for later reference
            formContainer.dataset.cameraId = cameraId;
            
            // Create settings form
            formContainer.innerHTML = `
                <div class="mb-3">
                    <label for="cameraResolution" class="form-label">Resolution</label>
                    <select id="cameraResolution" class="form-control">
                        <option value="640x480">640x480</option>
                        <option value="1280x720" selected>1280x720</option>
                        <option value="1920x1080">1920x1080</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="cameraFps" class="form-label">Frame Rate (FPS)</label>
                    <select id="cameraFps" class="form-control">
                        <option value="15">15</option>
                        <option value="30" selected>30</option>
                        <option value="60">60</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="cameraBrightness" class="form-label">Brightness</label>
                    <input type="range" id="cameraBrightness" class="form-range" min="0" max="100" value="50">
                    <div class="text-center text-sm text-gray-600" id="brightnessValue">50</div>
                </div>
                <div class="mb-3">
                    <label for="cameraContrast" class="form-label">Contrast</label>
                    <input type="range" id="cameraContrast" class="form-range" min="0" max="100" value="50">
                    <div class="text-center text-sm text-gray-600" id="contrastValue">50</div>
                </div>
                <div class="mb-3">
                    <label for="cameraSaturation" class="form-label">Saturation</label>
                    <input type="range" id="cameraSaturation" class="form-range" min="0" max="100" value="50">
                    <div class="text-center text-sm text-gray-600" id="saturationValue">50</div>
                </div>
                <div class="mb-3">
                    <label for="cameraExposure" class="form-label">Exposure</label>
                    <input type="range" id="cameraExposure" class="form-range" min="0" max="100" value="50">
                    <div class="text-center text-sm text-gray-600" id="exposureValue">50</div>
                </div>
                <div class="mb-3">
                    <label for="cameraWhiteBalance" class="form-label">White Balance</label>
                    <select id="cameraWhiteBalance" class="form-control">
                        <option value="auto" selected>Auto</option>
                        <option value="incandescent">Incandescent</option>
                        <option value="fluorescent">Fluorescent</option>
                        <option value="daylight">Daylight</option>
                        <option value="cloudy">Cloudy</option>
                    </select>
                </div>
            `;
            
            // Add event listeners for range inputs
            document.getElementById('cameraBrightness').addEventListener('input', function() {
                document.getElementById('brightnessValue').textContent = this.value;
            });
            
            document.getElementById('cameraContrast').addEventListener('input', function() {
                document.getElementById('contrastValue').textContent = this.value;
            });
            
            document.getElementById('cameraSaturation').addEventListener('input', function() {
                document.getElementById('saturationValue').textContent = this.value;
            });
            
            document.getElementById('cameraExposure').addEventListener('input', function() {
                document.getElementById('exposureValue').textContent = this.value;
            });
            
            // Show modal
            modal.show();
        }
        
        // Function to save camera settings
        function saveCameraSettings() {
            const formContainer = document.getElementById('cameraSettingsForm');
            const cameraId = formContainer.dataset.cameraId;
            
            const settings = {
                resolution: document.getElementById('cameraResolution').value,
                fps: document.getElementById('cameraFps').value,
                brightness: document.getElementById('cameraBrightness').value,
                contrast: document.getElementById('cameraContrast').value,
                saturation: document.getElementById('cameraSaturation').value,
                exposure: document.getElementById('cameraExposure').value,
                whiteBalance: document.getElementById('cameraWhiteBalance').value
            };
            
            // Update camera settings
            window.cameraControl.updateCameraSettings(cameraId, settings);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('cameraSettingsModal'));
            modal.hide();
            
            showNotification('Camera settings saved successfully', 'success');
        }
        
        // Function to display snapshots
        function displaySnapshots(cameraId, snapshots) {
            const container = document.getElementById('snapshotsContainer');
            
            if (snapshots && snapshots.length > 0) {
                container.innerHTML = '';
                
                snapshots.forEach(snapshot => {
                    const snapshotItem = document.createElement('div');
                    snapshotItem.className = 'col-md-3 snapshot-item';
                    
                    const img = document.createElement('img');
                    img.src = snapshot.imageUrl || generateSimulatedSnapshot(cameraId);
                    img.className = 'snapshot-img';
                    
                    const info = document.createElement('div');
                    info.className = 'mt-2 text-center text-sm';
                    info.textContent = snapshot.timestamp || new Date().toLocaleString();
                    
                    snapshotItem.appendChild(img);
                    snapshotItem.appendChild(info);
                    container.appendChild(snapshotItem);
                });
            } else {
                container.innerHTML = '<div class="col-12 text-center text-gray-500 py-4">No snapshots taken yet</div>';
            }
        }
        
        // Function to generate simulated snapshot
        function generateSimulatedSnapshot(cameraId) {
            // Create a simple placeholder image using canvas
            const canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 480;
            const ctx = canvas.getContext('2d');
            
            // Background
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Camera label
            ctx.fillStyle = '#333';
            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`Camera ${cameraId} Snapshot`, canvas.width / 2, canvas.height / 2);
            
            // Timestamp
            ctx.fillStyle = '#666';
            ctx.font = '14px Arial';
            ctx.fillText(new Date().toLocaleString(), canvas.width / 2, canvas.height / 2 + 30);
            
            return canvas.toDataURL('image/png');
        }
        
        // Function to show notifications
        function showNotification(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            // Set background color based on type
            if (type === 'error') {
                toast.style.backgroundColor = '#999';
            } else if (type === 'success') {
                toast.style.backgroundColor = '#555';
            } else {
                toast.style.backgroundColor = '#333';
            }
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Show toast with animation
            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
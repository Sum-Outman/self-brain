{% extends "base.html" %}

{% block title %}System Settings - Self Brain{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/system_settings.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid system-settings-container">
    <div class="system-settings-header">
        <h1>System Settings</h1>
        <div>
            <button class="btn btn-outline-dark" onclick="saveAllSettings()">
                <i class="bi bi-save"></i> Save All Changes
            </button>
        </div>
    </div>

    <!-- Settings Tabs -->
    <div class="settings-tabs">
        <ul class="nav nav-tabs" id="settingsTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">General</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="models-tab" data-bs-toggle="tab" data-bs-target="#models" type="button" role="tab" aria-controls="models" aria-selected="false">Models</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="hardware-tab" data-bs-toggle="tab" data-bs-target="#hardware" type="button" role="tab" aria-controls="hardware" aria-selected="false">Hardware</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="training-tab" data-bs-toggle="tab" data-bs-target="#training" type="button" role="tab" aria-controls="training" aria-selected="false">Training</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api" type="button" role="tab" aria-controls="api" aria-selected="false">API</button>
            </li>
        </ul>
    </div>

    <!-- Settings Content -->
    <div class="tab-content" id="settingsTabContent">
        <!-- General Settings Tab -->
        <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-info-circle me-2"></i>System Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="systemName" class="form-label">System Name</label>
                                <input type="text" class="form-control" id="systemName" value="Self Brain" placeholder="System Name">
                            </div>
                            <div class="mb-3">
                                <label for="systemVersion" class="form-label">System Version</label>
                                <input type="text" class="form-control" id="systemVersion" value="1.0.0" placeholder="Version" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="teamEmail" class="form-label">Team Email</label>
                                <input type="email" class="form-control" id="teamEmail" value="silencecrowtom@qq.com" placeholder="Team Email">
                            </div>
                            <div class="mb-3">
                                <label for="logLevel" class="form-label">Log Level</label>
                                <select class="form-select" id="logLevel">
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="INFO" selected>INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Models Settings Tab -->
        <div class="tab-pane fade" id="models" role="tabpanel" aria-labelledby="models-tab">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-diagram-3 me-2"></i>Model Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <label class="form-label">Local Models</label>
                        <div id="modelRegistry" class="border p-3 bg-light">
                            <!-- Model registry content will be populated via JavaScript -->
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label">External API Settings</label>
                        <div class="border p-3 bg-light">
                            <div class="mb-3">
                                <label class="form-check-label">
                                    <input type="checkbox" class="form-check-input" id="enableExternalAPIs"> Enable External APIs
                                </label>
                            </div>
                            <div id="externalAPIConfigs" class="mt-3">
                                <!-- External API configuration will be populated via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hardware Settings Tab -->
        <div class="tab-pane fade" id="hardware" role="tabpanel" aria-labelledby="hardware-tab">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-camera me-2"></i>Camera Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-check-label">
                            <input type="checkbox" class="form-check-input" id="enableMultipleCameras" checked> Enable Multiple Cameras
                        </label>
                    </div>
                    <div class="mb-3">
                        <label for="maxCameras" class="form-label">Max Cameras</label>
                        <input type="number" class="form-control" id="maxCameras" value="4" min="1" max="8">
                    </div>
                    <div class="mb-3">
                        <label for="defaultResolution" class="form-label">Default Resolution</label>
                        <select class="form-select" id="defaultResolution">
                            <option value="640x480">640x480</option>
                            <option value="1280x720" selected>1280x720</option>
                            <option value="1920x1080">1920x1080</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-plug me-2"></i>Sensor Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-check-label">
                            <input type="checkbox" class="form-check-input" id="enableSerialPorts" checked> Enable Serial Ports
                        </label>
                    </div>
                    <div class="mb-3">
                        <label class="form-check-label">
                            <input type="checkbox" class="form-check-input" id="enableUSB" checked> Enable USB Sensors
                        </label>
                    </div>
                    <div class="mb-3">
                        <label for="defaultBaudrate" class="form-label">Default Baudrate</label>
                        <select class="form-select" id="defaultBaudrate">
                            <option value="9600">9600</option>
                            <option value="19200">19200</option>
                            <option value="38400">38400</option>
                            <option value="115200">115200</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Training Settings Tab -->
        <div class="tab-pane fade" id="training" role="tabpanel" aria-labelledby="training-tab">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-bar-chart me-2"></i>Training Parameters</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="defaultBatchSize" class="form-label">Default Batch Size</label>
                                <input type="number" class="form-control" id="defaultBatchSize" value="32" min="1">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="defaultLearningRate" class="form-label">Default Learning Rate</label>
                                <input type="number" class="form-control" id="defaultLearningRate" value="0.001" step="0.000001">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="defaultEpochs" class="form-label">Default Epochs</label>
                                <input type="number" class="form-control" id="defaultEpochs" value="100" min="1">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-check-label">
                            <input type="checkbox" class="form-check-input" id="trainFromScratch" checked> Train Models From Scratch
                        </label>
                    </div>
                    <div class="mb-3">
                        <label class="form-check-label">
                            <input type="checkbox" class="form-check-input" id="enableSelfLearning" checked> Enable Self-Learning
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Settings Tab -->
        <div class="tab-pane fade" id="api" role="tabpanel" aria-labelledby="api-tab">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-gear me-2"></i>API Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="apiPort" class="form-label">API Port</label>
                        <input type="number" class="form-control" id="apiPort" value="5000" min="1024" max="65535">
                    </div>
                    <div class="mb-3">
                        <label class="form-check-label">
                            <input type="checkbox" class="form-check-input" id="enableCORS" checked> Enable CORS
                        </label>
                    </div>
                    <div class="mb-3">
                        <label for="maxRequestSize" class="form-label">Max Request Size</label>
                        <input type="text" class="form-control" id="maxRequestSize" value="100MB" placeholder="Max Request Size">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>// <![CDATA[
    // Initialize system settings with data from server
    document.addEventListener('DOMContentLoaded', function() {
        // Model registry data (would typically come from server)
        var modelRegistryData = {};
        var systemConfig = {};
        
        try {
            // Parse model registry data if available
            modelRegistryData = JSON.parse('{{ model_registry_json|tojson|safe }}') || {};
        } catch (e) {
            console.log('No valid model registry data available.');
        }
        
        try {
            // Parse system config if available
            systemConfig = JSON.parse('{{ system_config|tojson|safe }}') || {};
        } catch (e) {
            console.log('No valid system config data available.');
        }
        
        // Populate model registry
        var modelRegistryEl = document.getElementById('modelRegistry');
        if (modelRegistryData && Object.keys(modelRegistryData).length > 0) {
            var html = '<table class="table table-sm table-striped">';
            html += '<thead><tr><th>Model</th><th>Enabled</th><th>External API</th><th>Action</th></tr></thead>';
            html += '<tbody>';
            
            var entries = Object.entries(modelRegistryData);
            for (var i = 0; i < entries.length; i++) {
                var modelId = entries[i][0];
                var model = entries[i][1];
                html += '<tr>';
                html += '<td>' + modelId + ' - ' + (model.description || '') + '</td>';
                html += '<td><input type="checkbox" class="form-check-input model-enable" data-model="' + modelId + '" ' + (model.active ? 'checked' : '') + '></td>';
                html += '<td><input type="checkbox" class="form-check-input model-external-api" data-model="' + modelId + '" ' + (model.enable_external_api ? 'checked' : '') + '></td>';
                html += '<td><button class="btn btn-outline-dark btn-sm" onclick="configureModelAPI(\'' + modelId + '\')">Configure</button></td>';
                html += '</tr>';
            }
            
            html += '</tbody>';
            html += '</table>';
            modelRegistryEl.innerHTML = html;
        } else {
            modelRegistryEl.innerHTML = '<p class="text-muted">No models available.</p>';
        }
        
        // Populate system configuration
        if (systemConfig) {
            // Hardware settings
            if (systemConfig.device_manager && systemConfig.device_manager.cameras) {
                document.getElementById('enableMultipleCameras').checked = systemConfig.device_manager.cameras.enable_multiple_cameras || true;
                document.getElementById('maxCameras').value = systemConfig.device_manager.cameras.max_cameras || 4;
            }
            
            if (systemConfig.device_manager && systemConfig.device_manager.sensors) {
                document.getElementById('enableSerialPorts').checked = systemConfig.device_manager.sensors.enable_serial_ports || true;
                document.getElementById('enableUSB').checked = systemConfig.device_manager.sensors.enable_usb || true;
                if (systemConfig.device_manager.sensors.default_baudrate) {
                    document.getElementById('defaultBaudrate').value = systemConfig.device_manager.sensors.default_baudrate;
                }
            }
            
            // Training settings
            if (systemConfig.training && systemConfig.training.default_params) {
                document.getElementById('defaultBatchSize').value = systemConfig.training.default_params.batch_size || 32;
                document.getElementById('defaultLearningRate').value = systemConfig.training.default_params.learning_rate || 0.001;
                document.getElementById('defaultEpochs').value = systemConfig.training.default_params.epochs || 100;
                document.getElementById('trainFromScratch').checked = systemConfig.training.default_params.from_scratch !== false;
            }
        }
    });
    
    // Save all settings
    function saveAllSettings() {
        var settings = {
            system: {
                name: document.getElementById('systemName').value,
                team_email: document.getElementById('teamEmail').value,
                log_level: document.getElementById('logLevel').value
            },
            models: {
                enable_external_apis: document.getElementById('enableExternalAPIs').checked,
                model_status: {}
            },
            hardware: {
                cameras: {
                    enable_multiple_cameras: document.getElementById('enableMultipleCameras').checked,
                    max_cameras: parseInt(document.getElementById('maxCameras').value),
                    default_resolution: document.getElementById('defaultResolution').value
                },
                sensors: {
                    enable_serial_ports: document.getElementById('enableSerialPorts').checked,
                    enable_usb: document.getElementById('enableUSB').checked,
                    default_baudrate: parseInt(document.getElementById('defaultBaudrate').value)
                }
            },
            training: {
                default_params: {
                    batch_size: parseInt(document.getElementById('defaultBatchSize').value),
                    learning_rate: parseFloat(document.getElementById('defaultLearningRate').value),
                    epochs: parseInt(document.getElementById('defaultEpochs').value),
                    from_scratch: document.getElementById('trainFromScratch').checked
                }
            },
            api: {
                port: parseInt(document.getElementById('apiPort').value),
                cors_enabled: document.getElementById('enableCORS').checked,
                max_request_size: document.getElementById('maxRequestSize').value
            }
        };
        
        // Collect model status
        var modelCheckboxes = document.querySelectorAll('.model-enable');
        for (var i = 0; i < modelCheckboxes.length; i++) {
            var checkbox = modelCheckboxes[i];
            var modelId = checkbox.getAttribute('data-model');
            var externalApiCheckbox = document.querySelector('.model-external-api[data-model="' + modelId + '"]');
            settings.models.model_status[modelId] = {
                active: checkbox.checked,
                enable_external_api: externalApiCheckbox ? externalApiCheckbox.checked : false
            };
        }
        
        // Send settings to server (would implement this in a real application)
        console.log('Saving settings:', settings);
        
        // Show success message
        alert('Settings saved successfully!');
    }
    
    // Configure model API
    function configureModelAPI(modelId) {
        // In a real application, this would open a modal or redirect to a configuration page
        alert('Configure API for model ' + modelId);
    }
// ]]>
</script>
{% endblock %}
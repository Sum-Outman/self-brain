{% extends 'base.html' %}
{% block title %}Self Brain - Advanced AI Management System{% endblock %}
{% block extra_css %}
<style>
    :root {
        --primary-color: #333333;
        --secondary-color: #555555;
        --accent-color: #777777;
        --light-gray: #f5f5f5;
        --medium-gray: #e0e0e0;
        --dark-gray: #333333;
        --text-color: #333333;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #FFFFFF;
        color: var(--text-color);
        line-height: 1.6;
    }
    
    .btn {
        border-radius: 6px;
        transition: all 0.3s ease;
    }
    
    .btn-gray {
        background-color: var(--medium-gray);
        color: var(--dark-gray);
        border: none;
    }
    
    .btn-gray:hover {
        background-color: var(--accent-color);
        color: white;
    }
    
    .card {
        border: 1px solid var(--medium-gray);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .card-header {
        background-color: #FFFFFF;
        border-bottom: 1px solid var(--medium-gray);
    }
    
    textarea {
        resize: none;
    }
    
    /* Camera System Styles */
    .camera-status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    
    .status-inactive {
        background-color: #cccccc;
    }
    
    .status-connecting {
        background-color: #ffcc00;
    }
    
    .status-active {
        background-color: #4caf50;
    }
    
    .camera-container {
        margin-bottom: 1rem;
    }
    
    /* Progress Bar Styles */
    .progress-bar {
        transition: width 0.5s ease;
    }
    
    /* Message Styles */
    .message-container {
        max-height: 400px;
        overflow-y: auto;
    }
    
    /* Animations */
    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1.2); opacity: 1; }
    }
    
    .animate-bounce {
        animation: bounce 1.4s infinite ease-in-out both;
    }
</style>
{% endblock %}

{% block content %}
    <!-- Main Content -->
    <main class="container py-5">
        <div class="row">
            <!-- Left Column - System Overview -->
            <div class="col-12 col-md-4">
                <!-- System Status Card -->
                <div class="bg-gray-50 rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-6 hover:shadow-md transition-all">
                    <div class="p-4 border-b border-gray-200">
                        <h2 class="text-base font-semibold text-gray-700">System Overview</h2>
                    </div>
                    
                    <div class="p-4 space-y-3">
                        <div class="flex items-center justify-between py-1 px-2 rounded-md hover:bg-gray-100 transition-colors">
                            <span class="text-sm text-gray-600">System Status</span>
                            <span class="text-sm font-medium text-success" id="systemStatusText">Operational</span>
                        </div>
                        <div class="flex items-center justify-between py-1 px-2 rounded-md hover:bg-gray-100 transition-colors">
                            <span class="text-sm text-gray-600">Hardware Status</span>
                            <span class="text-sm font-medium text-success" id="hardwareStatus">Optimal</span>
                        </div>
                        <div class="flex items-center justify-between py-1 px-2 rounded-md hover:bg-gray-100 transition-colors">
                            <span class="text-sm text-gray-600">Response Time</span>
                            <span class="text-sm font-medium text-gray-800" id="responseTime">&lt; 200ms</span>
                        </div>
                        <div class="flex items-center justify-between py-1 px-2 rounded-md hover:bg-gray-100 transition-colors">
                            <span class="text-sm text-gray-600">Models Online</span>
                            <span class="text-sm font-medium text-gray-800" id="modelsOnline">0/11</span>
                        </div>
                    </div>
                </div>
                
                <!-- AI Chat Interface -->
                <div class="bg-white rounded-xl shadow-sm border border-gray overflow-hidden">
                    <div class="p-4 border-b border-gray flex justify-between items-center">
                        <h2 class="text-lg font-bold text-dark">AI Assistant</h2>
                        <div class="flex space-x-2">
                            <button class="btn-gray rounded-lg p-2 hover:bg-gray-300 transition-colors" onclick="clearChat()">
                                <i class="fa fa-eraser"></i>
                            </button>
                            <button class="btn-gray rounded-lg p-2 hover:bg-gray-300 transition-colors" onclick="exportChat()">
                                <i class="fa fa-download"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Chat Messages Container -->
                    <div id="messagesContainer" class="p-4 h-[400px] overflow-y-auto">
                        <div class="text-center text-gray py-12">
                            <i class="fa fa-comments text-3xl mb-3 text-gray-400"></i>
                            <p class="text-sm">Start a conversation with the AI system</p>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="p-3 border-t border-gray flex flex-wrap gap-2">
                        <button class="px-3 py-1 text-xs bg-gray-light rounded-full text-gray hover:bg-gray-300 transition-colors" onclick="quickAction('summarize')">
                            <i class="fa fa-list-ul mr-1"></i>Summarize
                        </button>
                        <button class="px-3 py-1 text-xs bg-gray-light rounded-full text-gray hover:bg-gray-300 transition-colors" onclick="quickAction('translate')">
                            <i class="fa fa-language mr-1"></i>Translate
                        </button>
                        <button class="px-3 py-1 text-xs bg-gray-light rounded-full text-gray hover:bg-gray-300 transition-colors" onclick="quickAction('code')">
                            <i class="fa fa-code mr-1"></i>Generate Code
                        </button>
                        <button class="px-3 py-1 text-xs bg-gray-light rounded-full text-gray hover:bg-gray-300 transition-colors" onclick="quickAction('analyze')">
                            <i class="fa fa-bar-chart mr-1"></i>Analyze
                        </button>
                        <button class="px-3 py-1 text-xs bg-gray-light rounded-full text-gray hover:bg-gray-300 transition-colors" onclick="quickAction('brainstorm')">
                            <i class="fa fa-lightbulb-o mr-1"></i>Brainstorm
                        </button>
                    </div>
                    
                    <!-- Message Input Area -->
                    <div class="p-4 border-t border-gray">
                        <div class="relative">
                            <textarea id="messageInput" class="w-full p-3 border border-gray rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all resize-none" rows="1" placeholder="Type your message here..." onkeydown="handleKeyDown(event)" oninput="adjustTextareaHeight(this)"></textarea>
                        
                            <div class="absolute right-3 bottom-3 flex space-x-2">
                                <button class="text-gray hover:text-primary transition-colors p-1" onclick="toggleVoice()">
                                    <i class="fa fa-microphone"></i>
                                </button>
                                <label class="text-gray hover:text-primary transition-colors cursor-pointer p-1">
                                    <i class="fa fa-paperclip"></i>
                                    <input type="file" class="hidden">
                                </label>
                                <button class="bg-gray rounded-lg p-2 hover:bg-gray-300 transition-colors" onclick="sendMessage()">
                                    <i class="fa fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Middle Column - Model Management -->
            <div class="col-12 col-md-4">
                <!-- Model Management Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray overflow-hidden mb-6">
                    <div class="p-4 border-b border-gray">
                        <h2 class="text-lg font-bold text-dark">Model Management</h2>
                    </div>
                    
                    <div class="p-4">
                        <div id="modelStatusGrid" class="grid grid-cols-1 gap-3">
                            <!-- Model status items will be inserted here by JavaScript -->
                            <div class="text-center py-8 text-gray">
                                <i class="fa fa-refresh fa-spin text-2xl mb-3 text-gray-400"></i>
                                <p class="text-sm">Loading model status...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Camera Management -->
            <div class="col-12 col-md-4">
                
                <!-- Camera Management -->
                <div class="bg-white rounded-xl shadow-sm border border-gray overflow-hidden">
                    <div class="p-4 border-b border-gray flex justify-between items-center">
                        <h2 class="text-lg font-bold text-dark">Camera System</h2>
                        <button class="btn-gray rounded-lg px-3 py-1 text-sm hover:bg-gray-300 transition-colors" onclick="refreshCameraList()">
                            <i class="fa fa-refresh mr-1"></i> Refresh
                        </button>
                    </div>
                    
                    <div class="p-4" id="cameraList">
                        <div class="text-center py-8 text-gray">
                            <i class="fa fa-camera text-2xl mb-3 text-gray-400"></i>
                            <p class="text-sm">Loading camera list...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- JavaScript Functions -->
    <script>
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            window.currentPage = 'index';
            initSystemStatus();
            initModelStatus();
            initCameraSystem();
            
            // Start periodic training progress updates
            startTrainingProgressUpdates();
        });

        // System status initialization
        function initSystemStatus() {
            const systemStatus = document.getElementById('systemStatusText');
            const hardwareStatus = document.getElementById('hardwareStatus');
            const responseTime = document.getElementById('responseTime');
            const modelsOnline = document.getElementById('modelsOnline');
            
            if (systemStatus) systemStatus.textContent = 'Operational';
            if (hardwareStatus) hardwareStatus.textContent = 'Optimal';
            if (responseTime) responseTime.textContent = '< 200ms';
            if (modelsOnline) modelsOnline.textContent = '0/11';
        }

        // Model status initialization
        function initModelStatus() {
            // Initialize with empty model data
            const modelConfig = {
                manager_model: {
                    name: "Manager Model",
                    description: "Core AI management system",
                    status: "loading",
                    progress: 0,
                    type: "management"
                },
                language_model: {
                    name: "Language Model",
                    description: "Natural language processing",
                    status: "loading",
                    progress: 0,
                    type: "language"
                },
                audio_model: {
                    name: "Audio Model",
                    description: "Audio processing and synthesis",
                    status: "loading",
                    progress: 0,
                    type: "audio"
                },
                vision_model: {
                    name: "Vision Model",
                    description: "Image recognition and processing",
                    status: "loading",
                    progress: 0,
                    type: "vision"
                },
                video_model: {
                    name: "Video Model",
                    description: "Video analysis and processing",
                    status: "offline",
                    progress: 0,
                    type: "video"
                },
                spatial_model: {
                    name: "Spatial Model",
                    description: "3D spatial perception and mapping",
                    status: "offline",
                    progress: 0,
                    type: "spatial"
                },
                sensor_model: {
                    name: "Sensor Model",
                    description: "Sensor data processing",
                    status: "offline",
                    progress: 0,
                    type: "sensor"
                },
                control_model: {
                    name: "Control Model",
                    description: "Computer control system",
                    status: "offline",
                    progress: 0,
                    type: "control"
                },
                actuator_model: {
                    name: "Actuator Model",
                    description: "Actuator and device control",
                    status: "offline",
                    progress: 0,
                    type: "actuator"
                },
                knowledge_model: {
                    name: "Knowledge Model",
                    description: "Knowledge base and expert system",
                    status: "offline",
                    progress: 0,
                    type: "knowledge"
                },
                code_model: {
                    name: "Code Model",
                    description: "Code generation and optimization",
                    status: "offline",
                    progress: 0,
                    type: "code"
                }
            };
            
            updateModelStatusUI(modelConfig);
        }

        // Update model status UI
        function updateModelStatusUI(modelConfig) {
            const grid = document.getElementById('modelStatusGrid');
            if (grid) {
                grid.innerHTML = '';
                
                let onlineCount = 0;
                const totalModels = Object.keys(modelConfig).length;
                
                for (const [key, model] of Object.entries(modelConfig)) {
                    if (model.status === 'online') {
                        onlineCount++;
                    }
                    
                    const modelItem = document.createElement('div');
                    modelItem.className = 'flex items-center justify-between p-3 border border-gray rounded-lg hover:bg-gray-50 transition-colors';
                    
                    // Create model icon based on type
                    let iconClass = 'fa-cog';
                    switch(model.type) {
                        case 'management': iconClass = 'fa-sitemap'; break;
                        case 'language': iconClass = 'fa-comment'; break;
                        case 'audio': iconClass = 'fa-volume-up'; break;
                        case 'vision': iconClass = 'fa-eye'; break;
                        case 'video': iconClass = 'fa-film'; break;
                        case 'spatial': iconClass = 'fa-cube'; break;
                        case 'sensor': iconClass = 'fa-rss'; break;
                        case 'control': iconClass = 'fa-gamepad'; break;
                        case 'actuator': iconClass = 'fa-arrows-alt'; break;
                        case 'knowledge': iconClass = 'fa-book'; break;
                        case 'code': iconClass = 'fa-code'; break;
                    }
                    
                    // Add progress bar if model is training
                    const isTraining = model.status === 'training';
                    let progressHtml = '';
                    if (isTraining) {
                        progressHtml = `
                            <div class="w-full mt-2">
                                <div class="flex justify-between items-center text-xs text-gray mb-1">
                                    <span>Training</span>
                                    <span>${model.progress}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-1.5">
                                    <div class="bg-blue h-1.5 rounded-full" style="width: ${model.progress}%" aria-valuenow="${model.progress}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        `;
                    }
                    
                    modelItem.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gray flex items-center justify-center text-gray mr-3">
                                <i class="fa ${iconClass}"></i>
                            </div>
                            <div>
                                <div class="font-medium text-sm">${model.name}</div>
                                <div class="text-xs text-gray">${model.description}</div>
                                ${progressHtml}
                            </div>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="text-xs font-medium px-2 py-1 rounded-full ${model.status === 'online' ? 'bg-green-100 text-green-800' : model.status === 'training' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                                ${model.status === 'online' ? 'Online' : model.status === 'training' ? 'Training' : 'Offline'}
                            </span>
                        </div>
                    `;
                    
                    grid.appendChild(modelItem);
                }
                
                const modelsOnline = document.getElementById('modelsOnline');
                if (modelsOnline) {
                    modelsOnline.textContent = `${onlineCount}/${totalModels}`;
                }
            }
        }



        // Handle key down in textarea
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Adjust textarea height based on content
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        // Send message function
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messagesContainer = document.getElementById('messagesContainer');
            const message = messageInput.value.trim();
            
            if (!message || !messagesContainer) {
                return;
            }
            
            // Add user message to container
            addMessage('user', message);
            
            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typingIndicator';
            typingIndicator.className = 'flex items-center text-gray p-3 mb-3';
            typingIndicator.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gray flex items-center justify-center mr-3">
                    <i class="fa fa-robot text-gray-500"></i>
                </div>
                <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
            `;
            messagesContainer.appendChild(typingIndicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Call backend API to get response from main model
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Remove typing indicator
                if (document.getElementById('typingIndicator')) {
                    document.getElementById('typingIndicator').remove();
                }
                
                // Add response to container
                if (data.response) {
                    addMessage('ai', data.response);
                } else {
                    addMessage('ai', "Sorry, I couldn't generate a response. Please try again.");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Remove typing indicator
                if (document.getElementById('typingIndicator')) {
                    document.getElementById('typingIndicator').remove();
                }
                // Show error message
                addMessage('ai', "I'm sorry, but there was an error connecting to the AI model. Please try again later.");
            });
        }

        // Add message to container
        function addMessage(sender, message) {
            const messagesContainer = document.getElementById('messagesContainer');
            if (!messagesContainer) {
                return;
            }
            
            // Clear welcome message if it's the first message
            if (messagesContainer.querySelector('.text-center.text-gray.py-12')) {
                messagesContainer.innerHTML = '';
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-4`;
            
            const bgColor = sender === 'user' ? 'bg-gray' : 'bg-gray-light';
            const textColor = sender === 'user' ? 'text-white' : 'text-gray';
            const alignSelf = sender === 'user' ? 'flex-row-reverse' : 'flex-row';
            
            const iconClass = sender === 'user' ? 'fa-user' : 'fa-robot';
            
            messageElement.innerHTML = `
                <div class="flex items-start ${alignSelf} max-w-[80%]">
                    <div class="w-8 h-8 rounded-full ${bgColor} flex items-center justify-center ${textColor} mr-3 flex-shrink-0">
                        <i class="fa ${iconClass}"></i>
                    </div>
                    <div class="bg-gray-light rounded-lg p-3 ${textColor} text-sm">
                        ${message}
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Clear chat function
        function clearChat() {
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                messagesContainer.innerHTML = `
                    <div class="text-center text-gray py-12">
                        <i class="fa fa-comments text-3xl mb-3 text-gray-400"></i>
                        <p class="text-sm">Start a conversation with the AI system</p>
                    </div>
                `;
            }
        }

        // Export chat function
        function exportChat() {
            const messagesContainer = document.getElementById('messagesContainer');
            if (!messagesContainer || messagesContainer.querySelector('.text-center.text-gray.py-12')) {
                showToast('No chat history to export', 'warning');
                return;
            }
            
            // Collect messages
            const messages = [];
            const messageElements = messagesContainer.querySelectorAll('.flex.mb-4');
            
            messageElements.forEach(element => {
                const sender = element.classList.contains('justify-end') ? 'User' : 'AI';
                const messageText = element.querySelector('.rounded-lg.p-3').textContent.trim();
                messages.push(`${sender}: ${messageText}`);
            });
            
            // Create and download text file
            const blob = new Blob([messages.join('\n\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_history_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Chat history exported successfully', 'success');
        }

        // Quick action function
        function quickAction(type) {
            const messageInput = document.getElementById('messageInput');
            if (!messageInput) {
                return;
            }
            
            let prompt = '';
            switch(type) {
                case 'summarize':
                    prompt = 'Please summarize the following information: ';
                    break;
                case 'translate':
                    prompt = 'Translate the following text to English: ';
                    break;
                case 'code':
                    prompt = 'Write code for: ';
                    break;
                case 'analyze':
                    prompt = 'Analyze this data: ';
                    break;
                case 'brainstorm':
                    prompt = 'Brainstorm ideas for: ';
                    break;
            }
            
            messageInput.value = prompt;
            adjustTextareaHeight(messageInput);
            messageInput.focus();
        }

        // Toggle voice input
        function toggleVoice() {
            showToast('Voice input feature is not available yet', 'warning');
        }

        // Initialize camera system
        function initCameraSystem() {
            refreshCameraList();
        }

        // Refresh camera list
        function refreshCameraList() {
            const cameraList = document.getElementById('cameraList');
            if (!cameraList) {
                return;
            }
            
            cameraList.innerHTML = `
                <div class="text-center py-8 text-gray">
                    <i class="fa fa-refresh fa-spin text-2xl mb-3 text-gray-400"></i>
                    <p class="text-sm">Loading camera list...</p>
                </div>
            `;
            
            // Simulate API call to get camera list
            setTimeout(() => {
                // Sample camera data
                const cameras = [
                    {
                        id: 'camera_1',
                        name: 'Front Camera',
                        status: 'inactive',
                        resolution: '1920x1080',
                        fps: '30'
                    },
                    {
                        id: 'camera_2',
                        name: 'Side Camera',
                        status: 'inactive',
                        resolution: '1280x720',
                        fps: '30'
                    },
                    {
                        id: 'camera_3',
                        name: 'Webcam',
                        status: 'active',
                        resolution: '640x480',
                        fps: '30'
                    }
                ];
                
                // Update camera list
                cameraList.innerHTML = '';
                
                cameras.forEach(camera => {
                    const cameraElement = document.createElement('div');
                    cameraElement.className = 'camera-container p-3 border border-gray rounded-lg hover:bg-gray-50 transition-colors';
                    
                    cameraElement.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-medium text-sm">${camera.name}</div>
                            <span class="camera-status-indicator status-${camera.status}"></span>
                        </div>
                        <div class="text-xs text-gray mb-2">Resolution: ${camera.resolution}, FPS: ${camera.fps}</div>
                        <div class="flex space-x-2">
                            <button class="btn-gray rounded-lg px-3 py-1 text-xs hover:bg-gray-300 transition-colors" onclick="toggleCamera('${camera.id}')">
                                <i class="fa fa-power-off mr-1"></i> ${camera.status === 'active' ? 'Turn Off' : 'Turn On'}
                            </button>
                            <button class="btn-gray rounded-lg px-3 py-1 text-xs hover:bg-gray-300 transition-colors" onclick="viewCamera('${camera.id}')">
                                <i class="fa fa-eye mr-1"></i> View
                            </button>
                        </div>
                    `;
                    
                    cameraList.appendChild(cameraElement);
                });
                
                // Add stereo vision controls if there are multiple cameras
                if (cameras.length >= 2) {
                    const stereoControls = document.createElement('div');
                    stereoControls.className = 'p-3 border border-gray rounded-lg bg-gray-50';
                    stereoControls.innerHTML = `
                        <div class="font-medium text-sm mb-2">Stereo Vision</div>
                        <div class="flex space-x-2">
                            <button class="btn-gray rounded-lg px-3 py-1 text-xs hover:bg-gray-300 transition-colors" onclick="startStereoVision()">
                                <i class="fa fa-play mr-1"></i> Start
                            </button>
                            <button class="btn-gray rounded-lg px-3 py-1 text-xs hover:bg-gray-300 transition-colors" onclick="stopStereoVision()">
                                <i class="fa fa-stop mr-1"></i> Stop
                            </button>
                        </div>
                    `;
                    
                    cameraList.appendChild(stereoControls);
                }
            }, 1500);
        }

        // Toggle camera state
        function toggleCamera(cameraId) {
            showToast(`Camera ${cameraId} toggled`, 'info');
            refreshCameraList();
        }
        
        // Get training progress from API
        function getTrainingProgress() {
            return fetch('/api/training/progress')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success' && data.data) {
                        return data.data;
                    } else {
                        console.warn('Invalid training progress data:', data);
                        return null;
                    }
                })
                .catch(error => {
                    console.error('Error fetching training progress:', error);
                    return null;
                });
        }
        
        // Update training progress in UI
        function updateTrainingProgress(progressData) {
            if (!progressData) return;
            
            // Update model status with training progress
            const modelConfig = getCurrentModelConfig();
            
            // Update the model that's currently being trained
            if (progressData.model_id && modelConfig[progressData.model_id]) {
                modelConfig[progressData.model_id].status = progressData.status === 'training' ? 'training' : 'online';
                modelConfig[progressData.model_id].progress = progressData.progress || 0;
                
                // Add more details to the description if available
                if (progressData.current_epoch && progressData.total_epochs) {
                    modelConfig[progressData.model_id].description = `${modelConfig[progressData.model_id].description} | Epoch ${progressData.current_epoch}/${progressData.total_epochs}`;
                }
            }
            
            // Update UI
            updateModelStatusUI(modelConfig);
        }
        
        // Start periodic training progress updates
        function startTrainingProgressUpdates() {
            // Get initial progress
            getTrainingProgress().then(progressData => {
                updateTrainingProgress(progressData);
            });
            
            // Set interval for periodic updates (every 5 seconds)
            window.trainingProgressInterval = setInterval(() => {
                getTrainingProgress().then(progressData => {
                    updateTrainingProgress(progressData);
                });
            }, 5000);
        }
        
        // Get current model configuration
        function getCurrentModelConfig() {
            // Initialize with default model data
            const modelConfig = {
                manager_model: {
                    name: "Manager Model",
                    description: "Core AI management system",
                    status: "loading",
                    progress: 0,
                    type: "management"
                },
                language_model: {
                    name: "Language Model",
                    description: "Natural language processing",
                    status: "loading",
                    progress: 0,
                    type: "language"
                },
                audio_model: {
                    name: "Audio Model",
                    description: "Audio processing and synthesis",
                    status: "loading",
                    progress: 0,
                    type: "audio"
                },
                vision_model: {
                    name: "Vision Model",
                    description: "Image recognition and processing",
                    status: "loading",
                    progress: 0,
                    type: "vision"
                },
                video_model: {
                    name: "Video Model",
                    description: "Video analysis and processing",
                    status: "loading",
                    progress: 0,
                    type: "video"
                },
                spatial_model: {
                    name: "Spatial Model",
                    description: "3D spatial perception and mapping",
                    status: "loading",
                    progress: 0,
                    type: "spatial"
                },
                sensor_model: {
                    name: "Sensor Model",
                    description: "Sensor data processing",
                    status: "loading",
                    progress: 0,
                    type: "sensor"
                },
                control_model: {
                    name: "Control Model",
                    description: "Computer control system",
                    status: "loading",
                    progress: 0,
                    type: "control"
                },
                actuator_model: {
                    name: "Actuator Model",
                    description: "Actuator and device control",
                    status: "loading",
                    progress: 0,
                    type: "actuator"
                },
                knowledge_model: {
                    name: "Knowledge Model",
                    description: "Knowledge base and expert system",
                    status: "loading",
                    progress: 0,
                    type: "knowledge"
                },
                code_model: {
                    name: "Code Model",
                    description: "Code generation and optimization",
                    status: "loading",
                    progress: 0,
                    type: "code"
                }
            };
            
            return modelConfig;
        }

        // View camera feed
        function viewCamera(cameraId) {
            showToast(`Opening camera ${cameraId} feed`, 'info');
        }

        // Start stereo vision
        function startStereoVision() {
            showToast('Stereo vision started', 'success');
        }

        // Stop stereo vision
        function stopStereoVision() {
            showToast('Stereo vision stopped', 'info');
        }

        // Show toast message
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                console.error('Toast container not found');
                return;
            }
            
            const toastId = 'toast-' + Date.now();
            
            // Set icon and color based on type
            let iconClass = 'fa-info-circle';
            let bgColor = 'bg-gray';
            let textColor = 'text-white';
            
            switch(type) {
                case 'success':
                    iconClass = 'fa-check-circle';
                    bgColor = 'bg-green';
                    break;
                case 'error':
                    iconClass = 'fa-exclamation-circle';
                    bgColor = 'bg-red';
                    break;
                case 'warning':
                    iconClass = 'fa-exclamation-triangle';
                    bgColor = 'bg-yellow';
                    textColor = 'text-gray';
                    break;
            }
            
            const toastHtml = `
                <div class="toast" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true" data-delay="${duration}">
                    <div class="toast-header ${bgColor} ${textColor}">
                        <i class="fa ${iconClass} mr-2"></i>
                        <strong class="mr-auto">Notification</strong>
                        <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toast = new bootstrap.Toast(document.getElementById(toastId));
            toast.show();
            
            // Remove toast after duration
            setTimeout(() => {
                const toastElement = document.getElementById(toastId);
                if (toastElement) {
                    toastElement.remove();
                }
            }, duration + 100);
        }

        // Theme toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const toggleThemeButton = document.getElementById('toggleTheme');
            if (!toggleThemeButton) {
                return;
            }
            
            toggleThemeButton.addEventListener('click', function() {
                const html = document.documentElement;
                const isDark = html.classList.toggle('dark-mode');
                
                // Update button icon
                if (isDark) {
                    toggleThemeButton.innerHTML = '<i class="fa fa-sun-o"></i>';
                    showToast('Dark mode enabled', 'info');
                } else {
                    toggleThemeButton.innerHTML = '<i class="fa fa-moon-o"></i>';
                    showToast('Light mode enabled', 'info');
                }
                
                // Store preference
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
            
            // Load stored preference
            const storedTheme = localStorage.getItem('theme');
            const html = document.documentElement;
            
            if (storedTheme === 'dark') {
                html.classList.add('dark-mode');
                if (toggleThemeButton) {
                    toggleThemeButton.innerHTML = '<i class="fa fa-sun-o"></i>';
                }
            }
        });
        
        // Clean up resources when page is unloaded
        window.addEventListener('beforeunload', function() {
            // Clear training progress update interval
            if (window.trainingProgressInterval) {
                clearInterval(window.trainingProgressInterval);
                window.trainingProgressInterval = null;
            }
        });
    </script>
{% endblock %}
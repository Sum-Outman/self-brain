<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Test - Self Brain AGI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 900px;
        }
        .card {
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
        }
        .card-header {
            background-color: #ffffff;
            border-bottom: 1px solid #dee2e6;
        }
        .video-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .video-wrapper {
            position: relative;
            width: 400px;
            height: 300px;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .camera-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        .btn-group {
            margin-bottom: 15px;
        }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 0.5rem;
            overflow-x: auto;
            max-height: 300px;
        }
        .alert {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Camera Test Interface</h1>
        
        <!-- Camera Controls -->
        <div class="card">
            <div class="card-header">
                <h5>Camera Controls</h5>
            </div>
            <div class="card-body">
                <div class="btn-group" role="group">
                    <button id="listCamerasBtn" class="btn btn-primary">
                        <i class="bi bi-list-check"></i> List Cameras
                    </button>
                    <button id="startDefaultCameraBtn" class="btn btn-success">
                        <i class="bi bi-camera-video"></i> Start Default Camera
                    </button>
                    <button id="stopCameraBtn" class="btn btn-danger">
                        <i class="bi bi-stop-circle"></i> Stop Camera
                    </button>
                    <button id="takeSnapshotBtn" class="btn btn-info">
                        <i class="bi bi-camera"></i> Take Snapshot
                    </button>
                </div>
                
                <div class="mt-3">
                    <label for="cameraSelector" class="form-label">Select Camera:</label>
                    <select id="cameraSelector" class="form-select">
                        <option value="default">Default Camera</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Active Camera Inputs -->
        <div class="card">
            <div class="card-header">
                <h5>Active Camera Inputs (From API)</h5>
                <button id="refreshCameraInputsBtn" class="btn btn-sm btn-secondary">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <pre id="cameraInputsResult" class="bg-light p-3 rounded">Click Refresh to load camera inputs...</pre>
            </div>
        </div>
        
        <!-- Camera Preview -->
        <div class="card">
            <div class="card-header">
                <h5>Camera Preview</h5>
            </div>
            <div class="card-body">
                <div class="video-container">
                    <div class="video-wrapper">
                        <video id="cameraPreview" autoplay muted></video>
                        <div class="camera-info" id="cameraInfo">Camera Feed</div>
                    </div>
                </div>
                
                <!-- Snapshot Preview -->
                <div id="snapshotContainer" class="d-none">
                    <h6>Snapshot Preview:</h6>
                    <img id="snapshotPreview" class="img-thumbnail" alt="Camera Snapshot">
                </div>
            </div>
        </div>
        
        <!-- Camera Test Results -->
        <div class="card">
            <div class="card-header">
                <h5>Test Results</h5>
            </div>
            <div class="card-body">
                <div id="testResult" class="alert alert-info">
                    Ready to test camera functionality.
                </div>
                <pre id="consoleOutput"></pre>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/camera_control.js"></script>
    <script>
        // DOM Elements
        const listCamerasBtn = document.getElementById('listCamerasBtn');
        const startDefaultCameraBtn = document.getElementById('startDefaultCameraBtn');
        const stopCameraBtn = document.getElementById('stopCameraBtn');
        const takeSnapshotBtn = document.getElementById('takeSnapshotBtn');
        const refreshCameraInputsBtn = document.getElementById('refreshCameraInputsBtn');
        const cameraSelector = document.getElementById('cameraSelector');
        const cameraInputsResult = document.getElementById('cameraInputsResult');
        const cameraPreview = document.getElementById('cameraPreview');
        const cameraInfo = document.getElementById('cameraInfo');
        const snapshotContainer = document.getElementById('snapshotContainer');
        const snapshotPreview = document.getElementById('snapshotPreview');
        const testResult = document.getElementById('testResult');
        const consoleOutput = document.getElementById('consoleOutput');
        
        // Log function
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            consoleOutput.textContent += `[${timestamp}] ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        // Clear log
        function clearLog() {
            consoleOutput.textContent = '';
        }
        
        // Display test result
        function displayResult(success, message) {
            testResult.className = success ? 'alert alert-success' : 'alert alert-danger';
            testResult.textContent = message;
        }
        
        // List available cameras
        listCamerasBtn.addEventListener('click', async function() {
            try {
                clearLog();
                log('Listing available cameras...');
                
                // Clear previous options
                cameraSelector.innerHTML = '<option value="default">Default Camera</option>';
                
                // Get available cameras
                const cameras = await CameraControl.getAvailableCameras();
                
                if (cameras.length > 0) {
                    log(`Found ${cameras.length} cameras.`);
                    
                    // Add cameras to selector
                    cameras.forEach((camera, index) => {
                        const option = document.createElement('option');
                        option.value = camera.deviceId;
                        option.textContent = `Camera ${index + 1}: ${camera.label || 'Unknown'}`;
                        cameraSelector.appendChild(option);
                    });
                    
                    displayResult(true, `Successfully listed ${cameras.length} cameras.`);
                } else {
                    log('No cameras found.');
                    displayResult(false, 'No cameras found on this device.');
                }
            } catch (error) {
                log(`Error: ${error.message}`);
                displayResult(false, `Failed to list cameras: ${error.message}`);
            }
        });
        
        // Start default camera
        startDefaultCameraBtn.addEventListener('click', async function() {
            try {
                clearLog();
                log('Starting camera...');
                
                const selectedCameraId = cameraSelector.value;
                const constraints = {
                    video: selectedCameraId === 'default' ? true : { deviceId: selectedCameraId }
                };
                
                // Stop any existing stream
                if (window.currentCameraStream) {
                    CameraControl.stopCameraStream(window.currentCameraStream);
                }
                
                // Start new stream
                window.currentCameraStream = await CameraControl.startCameraStream(constraints);
                
                // Attach stream to video element
                cameraPreview.srcObject = window.currentCameraStream;
                
                // Update camera info
                const selectedOption = cameraSelector.options[cameraSelector.selectedIndex];
                cameraInfo.textContent = selectedOption.textContent;
                
                log('Camera started successfully.');
                displayResult(true, 'Camera started successfully.');
            } catch (error) {
                log(`Error: ${error.message}`);
                displayResult(false, `Failed to start camera: ${error.message}`);
            }
        });
        
        // Stop camera
        stopCameraBtn.addEventListener('click', function() {
            try {
                clearLog();
                
                if (window.currentCameraStream) {
                    CameraControl.stopCameraStream(window.currentCameraStream);
                    cameraPreview.srcObject = null;
                    window.currentCameraStream = null;
                    log('Camera stopped.');
                    displayResult(true, 'Camera stopped successfully.');
                } else {
                    log('No active camera stream to stop.');
                    displayResult(false, 'No active camera stream to stop.');
                }
            } catch (error) {
                log(`Error: ${error.message}`);
                displayResult(false, `Failed to stop camera: ${error.message}`);
            }
        });
        
        // Take snapshot
        takeSnapshotBtn.addEventListener('click', function() {
            try {
                clearLog();
                
                if (!window.currentCameraStream) {
                    log('No active camera stream to take snapshot.');
                    displayResult(false, 'Please start a camera first.');
                    return;
                }
                
                // Take snapshot
                const snapshotDataUrl = CameraControl.takeSnapshot('cameraPreview');
                
                if (snapshotDataUrl) {
                    // Display snapshot
                    snapshotPreview.src = snapshotDataUrl;
                    snapshotContainer.classList.remove('d-none');
                    
                    log('Snapshot taken successfully.');
                    displayResult(true, 'Snapshot taken successfully.');
                } else {
                    log('Failed to take snapshot.');
                    displayResult(false, 'Failed to take snapshot.');
                }
            } catch (error) {
                log(`Error: ${error.message}`);
                displayResult(false, `Failed to take snapshot: ${error.message}`);
            }
        });
        
        // Refresh camera inputs from API
        refreshCameraInputsBtn.addEventListener('click', async function() {
            try {
                clearLog();
                log('Fetching camera inputs from API...');
                
                // Get camera inputs from API
                const result = await fetch('/api/camera/inputs');
                const data = await result.json();
                
                // Format and display result
                cameraInputsResult.textContent = JSON.stringify(data, null, 2);
                
                log('Camera inputs fetched successfully.');
                
                if (data.status === 'success') {
                    displayResult(true, `Successfully fetched ${data.camera_count || 0} camera inputs.`);
                } else {
                    displayResult(false, `API returned error: ${data.message}`);
                }
            } catch (error) {
                log(`Error: ${error.message}`);
                displayResult(false, `Failed to fetch camera inputs: ${error.message}`);
                cameraInputsResult.textContent = `Error: ${error.message}`;
            }
        });
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            log('Camera test page loaded.');
            displayResult(true, 'Ready to test camera functionality.');
        });
    </script>
</body>
</html>
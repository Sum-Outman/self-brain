{% extends "base_monochrome.html" %}

{% block title %}Device Communication{% endblock %}

{% block styles %}
<style>
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    h1 {
        margin-top: 0;
        color: #333;
    }
    .section {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .section h2 {
        margin-top: 0;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }
    .device-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    .device-item {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        transition: transform 0.3s, box-shadow 0.3s;
    }
    .device-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .device-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .device-name {
        font-weight: bold;
        font-size: 16px;
    }
    .device-status {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
    }
    .status-connected {
        background-color: #e0e0e0;
        color: #333333;
    }
    .status-disconnected {
        background-color: #f0f0f0;
        color: #666666;
    }
    .device-info {
        font-size: 14px;
        color: #666;
        margin-bottom: 10px;
    }
    .device-controls {
        display: flex;
        gap: 10px;
    }
    .btn {
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
    }
    .btn-outline-dark {
        background-color: white;
        color: #333333;
        border: 1px solid #333333;
    }
    .btn-outline-dark:hover {
        background-color: #f0f0f0;
    }
    .btn-outline-secondary {
        background-color: white;
        color: #666666;
        border: 1px solid #e0e0e0;
    }
    .btn-outline-secondary:hover {
        background-color: #f9f9f9;
    }
    .serial-communication {
        margin-top: 20px;
    }
    .serial-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        align-items: flex-end;
    }
    .control-group {
        margin-bottom: 10px;
    }
    .control-label {
        display: block;
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
    }
    .control-input {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    .port-select {
        flex: 2;
    }
    .baud-rate-select {
        flex: 1;
    }
    .serial-connect-btn {
        flex: 1;
    }
    .serial-command {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    .command-input {
        flex: 3;
    }
    .command-send-btn {
        flex: 1;
    }
    .serial-output {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
        margin-top: 10px;
    }
    .clear-output-btn {
        margin-top: 10px;
    }
    .sensor-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    .sensor-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background-color: #f9f9f9;
    }
    .sensor-name {
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
    }
    .sensor-value {
        font-size: 24px;
        font-weight: bold;
        color: #333333;
        text-align: center;
        margin: 10px 0;
    }
    .sensor-unit {
        font-size: 14px;
        color: #666;
    }
    .sensor-update {
        font-size: 12px;
        color: #999;
        text-align: right;
        margin-top: 10px;
    }
    .test-device-section {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }
    .test-result {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
        font-weight: bold;
    }
    .test-success {
        background-color: #f9f9f9;
        color: #333333;
        border: 1px solid #e0e0e0;
    }
    .test-error {
        background-color: #f9f9f9;
        color: #666666;
        border: 1px solid #e0e0e0;
    }
    .device-connection-status {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 4px;
        background-color: #f1f1f1;
    }
    .connection-status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 10px;
    }
    .indicator-connected {
        background-color: #333333;
    }
    .indicator-disconnected {
        background-color: #cccccc;
    }
    .connection-status-text {
        font-size: 14px;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>Device Communication</h1>
    
    <!-- Connection Status Bar -->
    <div class="device-connection-status">
        <div id="connection-status-indicator" class="connection-status-indicator indicator-disconnected"></div>
        <div id="connection-status-text" class="connection-status-text">Initializing device communication...</div>
    </div>
    
    <!-- System Sensors Section -->
    <div class="section">
        <h2>System Sensors</h2>
        <div class="sensor-grid" id="sensor-grid">
            <!-- Sensor cards will be inserted here by JavaScript -->
            <div class="sensor-card">
                <div style="text-align: center; color: #666;">Loading sensors...</div>
            </div>
        </div>
    </div>
    
    <!-- Serial Communication Section -->
    <div class="section">
        <h2>Serial Communication</h2>
        <div class="serial-communication">
            <div class="serial-controls">
                <div class="port-select control-group">
                    <label class="control-label" for="serial-port">Serial Port</label>
                    <select id="serial-port" class="control-input">
                        <option value="">Loading ports...</option>
                    </select>
                </div>
                <div class="baud-rate-select control-group">
                    <label class="control-label" for="baud-rate">Baud Rate</label>
                    <select id="baud-rate" class="control-input">
                        <option value="9600">9600</option>
                        <option value="19200">19200</option>
                        <option value="38400">38400</option>
                        <option value="57600">57600</option>
                        <option value="115200" selected>115200</option>
                    </select>
                </div>
                <div class="serial-connect-btn control-group" style="flex: 1; margin-bottom: 10px;">
                    <button id="connect-btn" class="btn btn-outline-dark" style="width: 100%; height: 100%;">Connect</button>
                </div>
            </div>
            
            <div class="serial-command">
                <div class="command-input control-group">
                    <input type="text" id="command-input" class="control-input" placeholder="Enter command to send">
                </div>
                <div class="command-send-btn control-group" style="flex: 1; margin-bottom: 10px;">
                    <button id="send-command-btn" class="btn btn-outline-secondary" style="width: 100%; height: 100%;" disabled>Send Command</button>
                </div>
            </div>
            
            <div class="serial-output" id="serial-output">
                <!-- Serial output will be displayed here -->
            </div>
            
            <button id="clear-output-btn" class="btn btn-outline-secondary clear-output-btn">Clear Output</button>
        </div>
    </div>
    
    <!-- Device Testing Section -->
    <div class="section">
        <h2>Device Testing</h2>
        <div class="test-device-section">
            <div style="flex: 1;">
                <h3>Microphone Test</h3>
                <button id="test-microphone-btn" class="btn btn-outline-dark">Test Microphone</button>
                <div id="microphone-test-result" class="test-result" style="display: none;"></div>
            </div>
            <div style="flex: 1;">
                <h3>Serial Permission Test</h3>
                <button id="test-serial-permission-btn" class="btn btn-outline-dark">Test Serial Permission</button>
                <div id="serial-permission-test-result" class="test-result" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/device_communication.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Reference to UI elements
        const sensorGrid = document.getElementById('sensor-grid');
        const serialPortSelect = document.getElementById('serial-port');
        const baudRateSelect = document.getElementById('baud-rate');
        const connectBtn = document.getElementById('connect-btn');
        const commandInput = document.getElementById('command-input');
        const sendCommandBtn = document.getElementById('send-command-btn');
        const serialOutput = document.getElementById('serial-output');
        const clearOutputBtn = document.getElementById('clear-output-btn');
        const testMicrophoneBtn = document.getElementById('test-microphone-btn');
        const microphoneTestResult = document.getElementById('microphone-test-result');
        const testSerialPermissionBtn = document.getElementById('test-serial-permission-btn');
        const serialPermissionTestResult = document.getElementById('serial-permission-test-result');
        const connectionStatusIndicator = document.getElementById('connection-status-indicator');
        const connectionStatusText = document.getElementById('connection-status-text');
        
        // Get reference to the global DeviceCommunication instance
        const deviceComm = window.DeviceCommunication;
        
        // Initialize device communication
        initDeviceCommunication();
        
        // Function to initialize device communication
        async function initDeviceCommunication() {
            try {
                // Initialize the device communication system
                const result = await deviceComm.initialize({
                    autoStartPolling: true,
                    pollingRate: 5000 // Update sensors every 5 seconds
                });
                
                if (result.status === 'success') {
                    updateConnectionStatus(true, 'Device communication initialized successfully');
                    
                    // Register sensor update callback
                    deviceComm.onSensorUpdate(onSensorDataUpdate);
                    
                    // Load initial data
                    loadSerialPorts();
                    
                    // Set up periodic port updates
                    setInterval(loadSerialPorts, 10000); // Update ports every 10 seconds
                    
                    // Set up status update interval
                    setInterval(updateConnectionStatusDisplay, 1000);
                } else {
                    updateConnectionStatus(false, result.message || 'Device communication initialization failed');
                    console.warn('Device communication initialization:', result.message);
                }
            } catch (error) {
                updateConnectionStatus(false, 'Error initializing device communication');
                console.error('Error initializing device communication:', error);
            }
        }
        
        // Callback function for sensor data updates
        function onSensorDataUpdate(sensorData) {
            if (sensorData.status === 'success' && sensorData.data) {
                updateSensorGrid(sensorData.data);
            }
        }
        
        // Function to update sensor grid
        function updateSensorGrid(data) {
            sensorGrid.innerHTML = '';
            
            // Create CPU sensor card
            const cpuCard = createSensorCard(
                'CPU Usage', 
                `${data.cpu ? data.cpu.percent.toFixed(1) : '0.0'}%`,
                '',
                data.timestamp
            );
            sensorGrid.appendChild(cpuCard);
            
            // Create Memory sensor card
            const memoryCard = createSensorCard(
                'Memory Usage', 
                `${data.memory ? data.memory.percent.toFixed(1) : '0.0'}%`,
                '',
                data.timestamp
            );
            sensorGrid.appendChild(memoryCard);
            
            // Create Disk sensor card
            const diskCard = createSensorCard(
                'Disk Usage', 
                `${data.disk ? data.disk.percent.toFixed(1) : '0.0'}%`,
                '',
                data.timestamp
            );
            sensorGrid.appendChild(diskCard);
            
            // Create Temperature sensor card (if available)
            if (data.temperature !== undefined && data.temperature !== null) {
                const tempCard = createSensorCard(
                    'Temperature', 
                    `${data.temperature.toFixed(1)}`,
                    '°C',
                    data.timestamp
                );
                sensorGrid.appendChild(tempCard);
            }
            
            // Add more sensor cards based on available data
            // Example for additional sensors if they exist in the data
            if (data.system_info) {
                const systemCard = createSensorCard(
                    'System', 
                    `${data.system_info.os || 'Unknown'}`,
                    `v${data.system_info.version || 'N/A'}`,
                    data.timestamp
                );
                sensorGrid.appendChild(systemCard);
            }
        }
        
        // Function to create a sensor card element
        function createSensorCard(name, value, unit, timestamp) {
            const card = document.createElement('div');
            card.className = 'sensor-card';
            
            const sensorName = document.createElement('div');
            sensorName.className = 'sensor-name';
            sensorName.textContent = name;
            
            const sensorValue = document.createElement('div');
            sensorValue.className = 'sensor-value';
            
            const valueSpan = document.createElement('span');
            valueSpan.textContent = value;
            
            const unitSpan = document.createElement('span');
            unitSpan.className = 'sensor-unit';
            unitSpan.textContent = unit;
            
            sensorValue.appendChild(valueSpan);
            sensorValue.appendChild(unitSpan);
            
            const sensorUpdate = document.createElement('div');
            sensorUpdate.className = 'sensor-update';
            
            // Validate and format timestamp to prevent errors
            try {
                // Enhanced validation to handle all timestamp formats
                let date;
                if (timestamp) {
                    try {
                        date = new Date(timestamp);
                        // Additional check to ensure the date is valid
                        if (isNaN(date.getTime())) {
                            throw new Error('Invalid timestamp');
                        }
                    } catch {
                        // If timestamp parsing fails, use current time
                        date = new Date();
                        console.warn('Invalid timestamp format, using current time');
                    }
                } else {
                    date = new Date();
                }
                sensorUpdate.textContent = `Updated: ${date.toLocaleTimeString()}`;
            } catch (error) {
                console.warn('Error formatting timestamp, using current time:', error);
                sensorUpdate.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
            }
            
            card.appendChild(sensorName);
            card.appendChild(sensorValue);
            card.appendChild(sensorUpdate);
            
            return card;
        }
        
        // Function to load serial ports
        async function loadSerialPorts() {
            try {
                const data = await deviceComm.getSerialPorts();
                
                if (data.status === 'success') {
                    // Save current selection
                    const currentSelection = serialPortSelect.value;
                    
                    // Clear existing options
                    serialPortSelect.innerHTML = '';
                    
                    // Add empty option
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = '-- Select Port --';
                    serialPortSelect.appendChild(emptyOption);
                    
                    // Add available ports
                    data.ports.forEach(port => {
                        const option = document.createElement('option');
                        option.value = port;
                        option.textContent = port;
                        
                        // Select the previously selected port if it's still available
                        if (port === currentSelection) {
                            option.selected = true;
                        }
                        
                        serialPortSelect.appendChild(option);
                    });
                } else {
                    console.error('Failed to load serial ports:', data.message);
                    appendToSerialOutput(`Failed to load serial ports: ${data.message}`);
                }
            } catch (error) {
                console.error('Error loading serial ports:', error);
                appendToSerialOutput(`Error loading serial ports: ${error.message}`);
            }
        }
        
        // Function to connect to serial port
        async function connectToSerialPort() {
            const port = serialPortSelect.value;
            const baudRate = parseInt(baudRateSelect.value);
            
            if (!port) {
                appendToSerialOutput('Please select a serial port.');
                return;
            }
            
            try {
                connectBtn.disabled = true;
                connectBtn.textContent = 'Connecting...';
                
                const data = await deviceComm.connectSerialPort(port, baudRate);
                
                if (data.status === 'success') {
                    connectBtn.textContent = 'Disconnect';
                    connectBtn.className = 'btn btn-danger';
                    sendCommandBtn.disabled = false;
                    serialPortSelect.disabled = true;
                    baudRateSelect.disabled = true;
                    appendToSerialOutput(`Connected to ${port} at ${baudRate} baud.`);
                } else {
                    appendToSerialOutput(`Failed to connect: ${data.message}`);
                }
            } catch (error) {
                console.error('Error connecting to serial port:', error);
                appendToSerialOutput(`Error connecting to serial port: ${error.message}`);
            } finally {
                connectBtn.disabled = false;
            }
        }
        
        // Function to disconnect from serial port
        async function disconnectFromSerialPort() {
            try {
                connectBtn.disabled = true;
                connectBtn.textContent = 'Disconnecting...';
                
                const data = await deviceComm.disconnectSerialPort();
                
                if (data.status === 'success') {
                    connectBtn.textContent = 'Connect';
                    connectBtn.className = 'btn btn-primary';
                    sendCommandBtn.disabled = true;
                    serialPortSelect.disabled = false;
                    baudRateSelect.disabled = false;
                    appendToSerialOutput('Disconnected from serial port.');
                } else {
                    appendToSerialOutput(`Failed to disconnect: ${data.message}`);
                }
            } catch (error) {
                console.error('Error disconnecting from serial port:', error);
                appendToSerialOutput(`Error disconnecting from serial port: ${error.message}`);
            } finally {
                connectBtn.disabled = false;
            }
        }
        
        // Function to send serial command
        async function sendSerialCommand() {
            const command = commandInput.value.trim();
            
            if (!command) {
                appendToSerialOutput('Please enter a command.');
                return;
            }
            
            try {
                sendCommandBtn.disabled = true;
                sendCommandBtn.textContent = 'Sending...';
                
                const data = await deviceComm.sendSerialCommand(command);
                
                if (data.status === 'success') {
                    appendToSerialOutput(`> ${command}`);
                    if (data.response) {
                        appendToSerialOutput(`< ${data.response}`);
                    }
                    commandInput.value = '';
                } else {
                    appendToSerialOutput(`Failed to send command: ${data.message}`);
                }
            } catch (error) {
                console.error('Error sending serial command:', error);
                appendToSerialOutput(`Error sending command: ${error.message}`);
            } finally {
                sendCommandBtn.disabled = false;
                sendCommandBtn.textContent = 'Send Command';
            }
        }
        
        // Function to append text to serial output
        function appendToSerialOutput(text) {
            const timestamp = new Date().toLocaleTimeString();
            serialOutput.textContent += `[${timestamp}] ${text}\n`;
            serialOutput.scrollTop = serialOutput.scrollHeight;
        }
        
        // Function to test microphone
        async function testMicrophone() {
            try {
                testMicrophoneBtn.disabled = true;
                testMicrophoneBtn.textContent = 'Testing...';
                microphoneTestResult.style.display = 'none';
                
                const data = await deviceComm.testMicrophone();
                
                if (data.status === 'success') {
                    microphoneTestResult.textContent = data.message;
                    microphoneTestResult.className = 'test-result test-success';
                } else {
                    microphoneTestResult.textContent = data.message;
                    microphoneTestResult.className = 'test-result test-error';
                }
            } catch (error) {
                console.error('Error testing microphone:', error);
                microphoneTestResult.textContent = `Error testing microphone: ${error.message}`;
                microphoneTestResult.className = 'test-result test-error';
            } finally {
                microphoneTestResult.style.display = 'block';
                testMicrophoneBtn.disabled = false;
                testMicrophoneBtn.textContent = 'Test Microphone';
            }
        }
        
        // Function to test serial permission
        async function testSerialPermission() {
            try {
                testSerialPermissionBtn.disabled = true;
                testSerialPermissionBtn.textContent = 'Testing...';
                serialPermissionTestResult.style.display = 'none';
                
                const data = await deviceComm.testSerialPermission();
                
                if (data.status === 'success') {
                    serialPermissionTestResult.textContent = data.message;
                    serialPermissionTestResult.className = 'test-result test-success';
                } else {
                    serialPermissionTestResult.textContent = data.message;
                    serialPermissionTestResult.className = 'test-result test-error';
                }
            } catch (error) {
                console.error('Error testing serial permission:', error);
                serialPermissionTestResult.textContent = `Error testing serial permission: ${error.message}`;
                serialPermissionTestResult.className = 'test-result test-error';
            } finally {
                serialPermissionTestResult.style.display = 'block';
                testSerialPermissionBtn.disabled = false;
                testSerialPermissionBtn.textContent = 'Test Serial Permission';
            }
        }
        
        // Function to update connection status display
        function updateConnectionStatusDisplay() {
            const status = deviceComm.getConnectionStatus();
            const isConnected = status.isConnected;
            const isPolling = status.isPolling;
            
            if (isConnected && isPolling) {
                updateConnectionStatus(true, `Connected to ${status.connection?.port || 'device'} and polling sensors`);
            } else if (isConnected) {
                updateConnectionStatus(true, `Connected to ${status.connection?.port || 'device'}`);
            } else if (isPolling) {
                updateConnectionStatus(true, 'Polling sensors (not connected to serial)');
            } else {
                updateConnectionStatus(false, 'Not connected');
            }
        }
        
        // Helper function to update connection status UI
        function updateConnectionStatus(isConnected, message) {
            if (isConnected) {
                connectionStatusIndicator.className = 'connection-status-indicator indicator-connected';
            } else {
                connectionStatusIndicator.className = 'connection-status-indicator indicator-disconnected';
            }
            connectionStatusText.textContent = message;
        }
        
        // Event listeners
        connectBtn.addEventListener('click', function() {
            const status = deviceComm.getConnectionStatus();
            if (status.isConnected) {
                disconnectFromSerialPort();
            } else {
                connectToSerialPort();
            }
        });
        
        sendCommandBtn.addEventListener('click', sendSerialCommand);
        
        commandInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendSerialCommand();
            }
        });
        
        clearOutputBtn.addEventListener('click', function() {
            serialOutput.textContent = '';
        });
        
        testMicrophoneBtn.addEventListener('click', testMicrophone);
        
        testSerialPermissionBtn.addEventListener('click', testSerialPermission);
        
        // Handle page unload
        window.addEventListener('beforeunload', function() {
            // Cleanup resources
            deviceComm.cleanup();
        });
    });
</script>
{% endblock %}